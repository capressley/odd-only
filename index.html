<script>
  // ===== Elements =====
  const welcome = document.getElementById("welcome");
  const game = document.getElementById("game");
  const end = document.getElementById("end");

  const startBtn = document.getElementById("startBtn");
  const againBtn = document.getElementById("againBtn");
  const tapBtn = document.getElementById("tapBtn");
  const quitBtn = document.getElementById("quitBtn");
  const backBtn = document.getElementById("backBtn");

  const scoreEl = document.getElementById("score");
  const numberEl = document.getElementById("number");
  const finalScoreEl = document.getElementById("finalScore");

  const shareBtn = document.getElementById("shareBtn");
  const toastEl = document.getElementById("toast");

  const boardEl = document.getElementById("leaderboard");
  const boardEndEl = document.getElementById("leaderboardEnd");

  const initialsWrap = document.getElementById("initialsWrap");
  const saveBtn = document.getElementById("saveBtn");
  const i1 = document.getElementById("i1");
  const i2 = document.getElementById("i2");
  const i3 = document.getElementById("i3");

  // ===== Leaderboard storage =====
  const LS_KEY = "oddOnlyHighScores_v1";
  const MAX_SCORES = 10;

  function loadScores() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(arr)) return [];
      return arr
        .filter(x => x && typeof x.name === "string" && typeof x.score === "number")
        .map(x => ({ name: x.name.slice(0,3).toUpperCase(), score: Math.trunc(x.score) }))
        .sort((a,b) => b.score - a.score)
        .slice(0, MAX_SCORES);
    } catch {
      return [];
    }
  }

  function saveScores(arr) {
    localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0, MAX_SCORES)));
  }

  function qualifies(score, scores) {
    if (score <= 0) return false;
    if (scores.length < MAX_SCORES) return true;
    return score > (scores[scores.length - 1]?.score ?? 0);
  }

  function renderScores() {
    const scores = loadScores();
    const html = scores.length
      ? scores.map((s, idx) => `
          <div class="row">
            <div class="rank">${String(idx+1).padStart(2,"0")}</div>
            <div class="name">${s.name}</div>
            <div class="pts">${s.score}</div>
          </div>
        `).join("")
      : `<div style="opacity:.75;">No scores yet. Be the first.</div>`;

    boardEl.innerHTML = html;
    boardEndEl.innerHTML = html;
  }

  // ===== Game state =====
  let score = 0;
  let strikes = 0;
  const MAX_STRIKES = 3;

  let current = 7;
  let running = false;
  let timer = null;

  // Missed-odd tracking
  let lastWasOdd = false;
  let tappedDuringThisNumber = false;

  // Timing: constant average + erratic cadence (no ramping)
  const BASE_MS = 950;
  const VAR_MS  = 260;

  function randInt(a, b) {
    return Math.floor(a + Math.random() * (b - a + 1));
  }

  function nextDelay() {
    return Math.max(300, BASE_MS + randInt(-VAR_MS, VAR_MS));
  }

  function show(screen) {
    welcome.classList.remove("active");
    game.classList.remove("active");
    end.classList.remove("active");
    screen.classList.add("active");
  }

  function setToast(msg) {
    toastEl.textContent = msg || "";
  }

  function updateHUD() {
    scoreEl.textContent = `Score: ${score} | Strikes: ${strikes}/${MAX_STRIKES}`;
  }

  function addStrike(reason) {
    strikes += 1;
    updateHUD();

    if (strikes >= MAX_STRIKES) {
      endGame();
    }
  }

  function newNumber() {
    // If the previous number was odd and player didn't tap it before it changed:
    if (lastWasOdd && !tappedDuringThisNumber) {
      score -= 1;         // scoring rule
      addStrike("missed_odd"); // strike rule
    }

    current = randInt(1, 999);
    numberEl.textContent = String(current);

    lastWasOdd = (current % 2 === 1);
    tappedDuringThisNumber = false;

    updateHUD();
  }

  function tick() {
    if (!running) return;
    newNumber();
    timer = setTimeout(tick, nextDelay());
  }

  function startGame() {
    clearTimeout(timer);
    timer = null;

    score = 0;
    strikes = 0;
    running = true;

    lastWasOdd = false;
    tappedDuringThisNumber = false;

    setToast("");

    initialsWrap.style.display = "none";
    i1.value = ""; i2.value = ""; i3.value = "";

    show(game);
    newNumber();
    tick();
  }

  function endGame() {
    running = false;
    clearTimeout(timer);
    timer = null;

    finalScoreEl.textContent = `Final Score: ${score} (Strikes: ${strikes}/${MAX_STRIKES})`;

    const scores = loadScores();
    if (qualifies(score, scores)) {
      initialsWrap.style.display = "flex";
      setTimeout(() => i1.focus(), 50);
    } else {
      initialsWrap.style.display = "none";
    }

    renderScores();
    show(end);
  }

  // ===== Tap logic =====
  // Correct odd tap: +1, no strike
  // Even tap: -1 + strike (but game continues until 3 strikes)
  tapBtn.addEventListener("click", () => {
    if (!running) return;

    tappedDuringThisNumber = true;

    if (current % 2 === 1) {
      score += 1;
      updateHUD();
      // optional: immediately roll a new number after a correct tap
      newNumber();
    } else {
      score -= 1;
      updateHUD();
      addStrike("tapped_even");
      // also roll a new number so it doesn't feel stuck
      if (running) newNumber();
    }
  });

  // ===== Initials + save =====
  function cleanChar(ch) {
    const up = (ch || "").toUpperCase();
    return /^[A-Z0-9]$/.test(up) ? up : "";
  }

  function wireInput(inp, next) {
    inp.addEventListener("input", () => {
      inp.value = cleanChar(inp.value);
      if (inp.value && next) next.focus();
    });
    inp.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !inp.value) {
        if (inp === i3) i2.focus();
        if (inp === i2) i1.focus();
      }
    });
  }
  wireInput(i1, i2);
  wireInput(i2, i3);
  wireInput(i3, null);

  saveBtn.addEventListener("click", () => {
    const name =
      (cleanChar(i1.value) || "A") +
      (cleanChar(i2.value) || "A") +
      (cleanChar(i3.value) || "A");

    const scores = loadScores();
    scores.push({ name, score });
    scores.sort((a,b) => b.score - a.score);
    saveScores(scores);

    initialsWrap.style.display = "none";
    setToast("Saved.");
    renderScores();
  });

  // ===== Share score =====
  shareBtn.addEventListener("click", async () => {
    const url = window.location.href.split("?")[0];
    const text = `I scored ${score} on Odd-Only Arcade (3 strikes mode). Beat that: ${url}`;

    try {
      if (navigator.share) {
        await navigator.share({ title: "Odd-Only Arcade", text, url });
        setToast("Shared!");
        return;
      }
    } catch { /* ignore */ }

    try {
      await navigator.clipboard.writeText(text);
      setToast("Copied to clipboard â€” paste into a text.");
    } catch {
      setToast(text);
    }
  });

  // ===== Navigation =====
  startBtn.addEventListener("click", startGame);
  againBtn.addEventListener("click", startGame);

  quitBtn.addEventListener("click", () => {
    running = false;
    clearTimeout(timer);
    timer = null;
    renderScores();
    show(welcome);
  });

  backBtn.addEventListener("click", () => {
    renderScores();
    show(welcome);
  });

  // Init
  renderScores();
</script>
